
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Basic Service Example &#8212; File Transfer DXL Python service 0.1.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="dxlfiletransferservice package" href="dxlfiletransferservice.html" />
    <link rel="prev" title="Basic Store Example" href="basicstoreexample.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dxlfiletransferservice.html" title="dxlfiletransferservice package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="basicstoreexample.html" title="Basic Store Example"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">File Transfer DXL Python service 0.1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="basic-service-example">
<h1>Basic Service Example<a class="headerlink" href="#basic-service-example" title="Permalink to this headline">¶</a></h1>
<p>This sample registers a file store request callback with DXL as part of a
&quot;custom&quot; service.</p>
<p>Following the instructions in the <a class="reference internal" href="running.html"><span class="doc">Running</span></a> document,
you can register a standalone File Transfer service with the DXL fabric.
This example shows how you can, alternatively, add file storage capabilities to
your own service — avoiding the need to register a separate, standalone
service with the DXL fabric.</p>
<p>The standalone File Transfer service has its own
<a class="reference internal" href="configuration.html#dxl-service-config-file-label"><span class="std std-ref">Service Configuration File</span></a> for managing
file storage settings — for example, the root directory under which files are
stored. With the &quot;custom&quot; service approach, you pass the desired configuration
values directly into the
<a class="reference internal" href="dxlfiletransferservice.requesthandlers.html#dxlfiletransferservice.requesthandlers.FileStoreRequestCallback" title="dxlfiletransferservice.requesthandlers.FileStoreRequestCallback"><code class="xref py py-class docutils literal notranslate"><span class="pre">dxlfiletransferservice.requesthandlers.FileStoreRequestCallback</span></code></a>
instance during construction. If you want to give end users the ability to
configure these settings, you could expose them as part of your service's
own configuration file.</p>
<p>The sample uses a client application wrapper to send a file via the
DXL fabric to the request callback for storage. The progress and result of the
file storage operation are displayed to the console.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The samples configuration step has been completed (see <a class="reference internal" href="sampleconfig.html"><span class="doc">Samples Configuration</span></a>)</li>
</ul>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Modify the example to include the storage directory under which the service
should store files sent to it.</p>
<p>For example:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STORAGE_DIR</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">dxl-file-store&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that the service would need to have write permissions to the directory
which is provided. If the directory does not exist when the service first starts
up, the service attempts to create the directory, including any intermediate
subdirectories in the path which may not yet exist.</p>
</div>
<div class="section" id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h2>
<p>To run this sample execute the <code class="docutils literal notranslate"><span class="pre">sample/basic/basic_service_example.py</span></code> script
with the path to the file to be sent to the service as a parameter. For example,
to send a file named <code class="docutils literal notranslate"><span class="pre">C:\test.exe</span></code> to the service, you could run the sample
as follows:</p>
<blockquote>
<div><pre class="literal-block">
python sample/basic/basic_service_example.py C:\test.exe
</pre>
</div></blockquote>
<p>As the file is being sent, a &quot;Percent complete&quot; indicator -- moving from 0% to
100% -- should be updated:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Percent complete: <span class="m">5</span>%
</pre></div>
</div>
</div></blockquote>
<p>After the file has been uploaded completely, the response from the service and
some summary information for the file store operation should be printed out. For
example:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Percent complete: <span class="m">100</span>%
Response:
<span class="o">{</span>
    <span class="s2">&quot;file_id&quot;</span>: <span class="s2">&quot;7b89f71d-f348-45ee-aef3-4ac2555e92f8&quot;</span>,
    <span class="s2">&quot;hashes&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;sha256&quot;</span>: <span class="s2">&quot;a2e52129a28feec1ee3f22f5aaf9bdecbb02d51af6da408ace0a2ac2e0365c8b&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;size&quot;</span>: <span class="m">89579672</span>
<span class="o">}</span>
Elapsed <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>: <span class="m">89546</span>.39649391174
</pre></div>
</div>
</div></blockquote>
<p>The service stores files under the directory configured for the <cite>STORAGE_DIR</cite>
constant. For example, if the <cite>STORAGE_DIR</cite> constant were set to
<code class="docutils literal notranslate"><span class="pre">C:\\dxl-file-store</span></code> and the base name of the file supplied as a parameter to
the <code class="docutils literal notranslate"><span class="pre">basic_service_example.py</span></code> script were <code class="docutils literal notranslate"><span class="pre">test.exe</span></code>, the file would be
stored at the following location:</p>
<blockquote>
<div><pre class="literal-block">
C:\dxl-file-store\test.exe
</pre>
</div></blockquote>
<p>If a second parameter is passed to the example when run, the extra parameter
is used as the name of the subdirectory under which the file should be stored.
For example, the following command could be run:</p>
<blockquote>
<div><pre class="literal-block">
python sample/basic/basic_store_example.py C:\test.exe storesub1/storesub2
</pre>
</div></blockquote>
<p>Assuming the storage directory setting on the server were specified as
<code class="docutils literal notranslate"><span class="pre">C:\\dxl-file-store</span></code>, the file would be stored at the following location:</p>
<blockquote>
<div><pre class="literal-block">
C:\dxl-file-store\storesub1\storesub2\test.exe
</pre>
</div></blockquote>
</div>
<div class="section" id="details">
<h2>Details<a class="headerlink" href="#details" title="Permalink to this headline">¶</a></h2>
<p>The majority of the sample code is shown below:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The topic for the service to respond to</span>
<span class="n">SERVICE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;/file-transfer-sample/basic-service&quot;</span>

<span class="o">...</span>

<span class="c1"># Create the client</span>
<span class="k">with</span> <span class="n">DxlClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">dxl_client</span><span class="p">:</span>

    <span class="c1"># Connect to the fabric</span>
    <span class="n">dxl_client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected to DXL fabric.&quot;</span><span class="p">)</span>

    <span class="c1"># Create service registration object</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">ServiceRegistrationInfo</span><span class="p">(</span><span class="n">dxl_client</span><span class="p">,</span> <span class="s2">&quot;myService&quot;</span><span class="p">)</span>

    <span class="c1"># Add a topic for the service to respond to</span>
    <span class="n">info</span><span class="o">.</span><span class="n">add_topic</span><span class="p">(</span><span class="n">SERVICE_TOPIC</span><span class="p">,</span>
                   <span class="n">FileStoreRequestCallback</span><span class="p">(</span><span class="n">dxl_client</span><span class="p">,</span> <span class="n">STORAGE_DIR</span><span class="p">))</span>

    <span class="c1"># Register the service with the fabric (wait up to 10 seconds for</span>
    <span class="c1"># registration to complete)</span>
    <span class="n">dxl_client</span><span class="o">.</span><span class="n">register_service_sync</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Create client wrapper</span>
    <span class="n">file_transfer_client</span> <span class="o">=</span> <span class="n">FileTransferClient</span><span class="p">(</span><span class="n">dxl_client</span><span class="p">,</span> <span class="n">SERVICE_TOPIC</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Invoke the send file request method to store the file on the server</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">file_transfer_client</span><span class="o">.</span><span class="n">send_file_request</span><span class="p">(</span>
        <span class="n">STORE_FILE_NAME</span><span class="p">,</span>
        <span class="n">file_name_on_server</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">STORE_FILE_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">STORE_FILE_NAME</span><span class="p">)),</span>
        <span class="n">max_segment_size</span><span class="o">=</span><span class="n">MAX_SEGMENT_SIZE</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">update_progress</span><span class="p">)</span>

    <span class="c1"># Print out the response (convert dictionary to JSON for pretty printing)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Response:</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">MessageUtils</span><span class="o">.</span><span class="n">dict_to_json</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time (ms): {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<p>The value for the <cite>SERVICE_TOPIC</cite> constant is used as a topic name on the DXL
fabric, both for registering a <code class="docutils literal notranslate"><span class="pre">request</span> <span class="pre">callback</span></code> and for file storage
requests made from a client.</p>
<p>After connecting to the DXL fabric, a service is registered. The service
registration associates an instance of the
<a class="reference internal" href="dxlfiletransferservice.requesthandlers.html#dxlfiletransferservice.requesthandlers.FileStoreRequestCallback" title="dxlfiletransferservice.requesthandlers.FileStoreRequestCallback"><code class="xref py py-class docutils literal notranslate"><span class="pre">dxlfiletransferservice.requesthandlers.FileStoreRequestCallback</span></code></a> class
with the <cite>SERVICE_TOPIC</cite>. The root directory under which the request callback
should store files is supplied to the callback, the <cite>STORAGE_DIR</cite> constant.</p>
<p>The next step is to create a <cite>FileTransferClient</cite>, including the <cite>SERVICE_TOPIC</cite>
constant as the name of the topic to use when sending to the DXL fabric the
segments of the file to store.</p>
<p>The final step is to invoke the <cite>send_file_request</cite> method on the
<cite>FileTransferClient</cite> instance. This call sends the file contents to the DXL
fabric. As the <cite>FileStoreRequestCallback</cite> request handler (registered with the
DXL fabric above) receives DXL <code class="docutils literal notranslate"><span class="pre">request</span> <span class="pre">messages</span></code> with the file segments, the
segments are reassembled into a single file which is stored to the file system.</p>
<p>Assuming the file store operation is successful, the last response from the
service is printed to the console output. The response contains a <code class="docutils literal notranslate"><span class="pre">sha256</span></code>
hash and <code class="docutils literal notranslate"><span class="pre">size</span></code> of the file bytes which were stored on the server.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Basic Service Example</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#running">Running</a></li>
<li><a class="reference internal" href="#details">Details</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="basicstoreexample.html"
                        title="previous chapter">Basic Store Example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="dxlfiletransferservice.html"
                        title="next chapter">dxlfiletransferservice package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/basicserviceexample.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dxlfiletransferservice.html" title="dxlfiletransferservice package"
             >next</a> |</li>
        <li class="right" >
          <a href="basicstoreexample.html" title="Basic Store Example"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">File Transfer DXL Python service 0.1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>